<dom-module id="create-user">
  <style>
    :host {
      display: block;
    }

    paper-button.colorful {
      color: #4285f4;
      margin-top: 1em;
    }

    paper-button[raised].colorful {
      background: var(--default-primary-color);
      color: #fff;
      margin: 10px;
    }

    paper-material {
      max-width: 700px;
      padding: 0.5em;
      text-align: center;
      min-width: 350px;
      margin: 0 auto;
      padding-bottom: 5em;
    }

    h2 {
      text-align: center;
    }

    #circleImage {
      text-align: center;
      padding: 1em;
      margin: 1em;
    }

    paper-input,
    gold-email-input {
      display: inline-block;
      min-width: 300px;
      padding-right: 1em;
      text-align: left;
    }

    .signInLink {
      text-align: center;
      max-width: 700px;
      text-decoration: none;
      margin: 0 auto;
      margin-top: 1em;
      margin-bottom: 1em;

    }

    a.style-scope.create-user {
      color: inherit;
      margin-left: 0.5em;
    }

    paper-button.colorful.signUpButton {
      margin-top: 2em;
    }

    #errorToast {
      --paper-toast-background-color: #db4437;
      --paper-toast-color: white;
    }

    #errorToast .toast-hide-button {
      color: #eeff41;
      font-weight: bold;
      margin: 10px;
    }

    .right {
      float: right;
    }
  </style>
  <template>
    <paper-material elevation="1" class="animated bounceInUp">
      <form is="iron-form" id="createUserForm">
      <h2 class="paper-font-display2">Create your Jarvis Account</h2>
        <img-base64 id="circleImage" width="150px" height="150px" title="Select your profile Image" placeholder="{{getAvatar()}}"></img-base64>
        <paper-input label="First Name" id="firstName" error-message="Please enter your First Name" auto-validate required></paper-input>
        <paper-input label="Last Name" id="lastName" error-message="Please enter your Second Name" auto-validate required></paper-input>
        <paper-input label="Designation" id="designation" error-message="Please enter your designation or Job Title" auto-validate required></paper-input>
        <paper-input label="Practice" id="practice" error-message="Please enter your practice. (QA, Developer)" auto-validate required></paper-input>
        <paper-input label="Project" id="project" error-message="Please enter your project name.(DTO, v4)" auto-validate required></paper-input>
        <paper-input label="Reporting Manager" id="reportingTo" error-message="Please enter your Reporting Manager" auto-validate required></paper-input>
        <paper-input label="Company Name" id="companyName" error-message="Please enter your Company Name (EE, NTT Data, epam)" auto-validate required></paper-input>
        <paper-input label="Phone Number" id="phoneNo" error-message="Please enter your Phone Number" auto-validate required></paper-input>
        <paper-input label="Employee Id" id="empId" error-message="Please enter a valid Employee Id" auto-validate required></paper-input>
        <paper-input label="Location" id="location" error-message="Please enter your work location" auto-validate required></paper-input>
        <gold-email-input id="emailId" label="User ID (yourname@domain.com)" error-message="Please enter a valid email" auto-validate required></gold-email-input>
        <paper-input label="Password" type="password" id="password" error-message="Please enter a valid password" auto-validate required></paper-input>
        <div class="">
          <paper-toast id="errorToast">
            <span class="toast-hide-button" role="button" tabindex="0" onclick="app.$.toast.hide()">Ok</span>
          </paper-toast>
          <paper-button tabindex="0" raised class="colorful signUpButton right" on-click="signUp">Sign Up</paper-button>
        </div>

      </form>
    </paper-material>

    <div class="signInLink animated bounceInUp">
      Already have an account?
      <a data-route="login" href="{{baseUrl}}login">
        <span>Sign In</span>
      </a>
    </div>
  </template>

  <script>
    Polymer({
      is: 'create-user',

      getAvatar: function() {
        return app.defaultAvatar;
      },

      validateForm: function() {
        var elements = document.querySelector('#createUserForm').querySelectorAll('paper-input, gold-email-input');
        for (var i = 0; i < elements.length; i++) {
          elements[i].validate();
        }
      },

      signUp: function() {
        var userForm = document.getElementById('createUserForm');
        if (userForm.checkValidity()) {
          this.createUserAccount();
        } else {
          this.validateForm();
          document.getElementById('errorToast').text = 'Enter values for highlighted fields.';
          document.getElementById('errorToast').show();
        }
      },

      createUserAccount: function() {
        console.log('Creating new Account...');
        var userRef = new Firebase(app.env.db.baseUrl);
        var picture = document.querySelector('#circleImage').querySelector('iron-image').src;
        var firstName = document.getElementById('firstName').value;
        var lastName = document.getElementById('lastName').value;
        var designation = document.getElementById('designation').value;
        var phoneNo = document.getElementById('phoneNo').value;
        var practice = document.getElementById('practice').value;
        var project = document.getElementById('project').value;
        var reportingTo = document.getElementById('reportingTo').value;
        var companyName = document.getElementById('companyName').value;
        var empId = document.getElementById('empId').value;
        var location = document.getElementById('location').value;
        var emailId = document.getElementById('emailId').value;
        var password = document.getElementById('password').value;
        var createdOn = Firebase.ServerValue.TIMESTAMP;

        userRef.createUser({
          email: emailId,
          password: password
        }, function(error, userData) {
          if (error) {
            console.log('Error creating new Account:', error);
            app.$.errorToast.text = 'Error creating new Account:';
            app.$.errorToast.show();
          } else {
            userRef.child('users').child(userData.uid).set({
              'uid': userData.uid,
              'picture': picture,
              'firstName': firstName,
              'lastName': lastName,
              'designation': designation,
              'phoneNo': phoneNo,
              'practice': practice,
              'projects': project,
              'reportingTo': reportingTo,
              'companyName': companyName,
              'empId': empId,
              'location': location,
              'emailId': emailId,
              'createdOn': createdOn
            });
            app.$.toast.text = 'Successfully created user account. Please login.';
            app.$.toast.duration = 5000;
            app.$.toast.show();
            page.redirect(app.baseUrl + 'login');
            console.log('Successfully created user account with uid:', userData.uid);
          }
        });
      }
    });
  </script>
</dom-module>
